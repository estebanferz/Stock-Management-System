---
import LayoutDashboard from "@/layouts/LayoutDashboard.astro";
import { requireAuth } from "@/lib/requireAuth";
import { serverApp } from "@/lib/serverAPI";
import { SubscribeCard } from "@/components/Billing/SubscribeCard";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");

const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };

const MP_PUBLIC_KEY = import.meta.env.PUBLIC_MP_PUBLIC_KEY;

const statusRes = await serverApp.billing.status.get(authed);
const data = statusRes.data;

const tenant = data?.tenant ?? null;
const plans = Array.isArray(data?.plans) ? data!.plans : [];
const nowIso = data?.now ?? new Date().toISOString();

function daysLeft(iso?: string | Date | null) {
  if (!iso) return null;
  const d = typeof iso === "string" ? new Date(iso) : iso;
  if (isNaN(d.getTime())) return null;
  const now = new Date(nowIso);
  const diffMs = d.getTime() - now.getTime();
  const days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
  return days;
}

const subscriptionStatus = (tenant?.subscription_status ?? "inactive") as
  | "trial"
  | "inactive"
  | "pending"
  | "active"
  | "past_due"
  | "canceled";

const trialEndsAt = tenant?.trial_ends_at ?? null;
const trialDaysLeft = trialEndsAt ? daysLeft(trialEndsAt as any) : null;

const currentPeriodEnd = tenant?.current_period_end ?? null;
const currentPeriodDaysLeft = currentPeriodEnd ? daysLeft(currentPeriodEnd as any) : null;

const currentPlanId = tenant?.subscription_plan_id ?? null;
const currentPlan = currentPlanId ? plans.find((p: any) => p.plan_id === currentPlanId) : null;

const fmtMoney = (amount: any, currency: any) =>
  new Intl.NumberFormat("es-AR", {
    style: "currency",
    currency: String(currency ?? "ARS"),
    maximumFractionDigits: 2,
  }).format(Number(amount ?? 0));
---

<LayoutDashboard title="Zuma+ Billing" user={auth.user}>
  <div class="px-3 mt-6">
    <h1 class="text-3xl font-bold text-gray-700">Facturación</h1>
    <p class="text-sm text-gray-600 mt-1">
      Gestioná tu suscripción y el estado de tu cuenta.
    </p>
  </div>

  <div class="px-3 mt-6 grid grid-cols-1 lg:grid-cols-3 gap-3 items-start">
    <!-- Estado actual -->
    <div class="bg-white rounded-2xl shadow-lg p-5 lg:col-span-1">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm font-semibold text-gray-900">Estado de la cuenta</div>
          <div class="mt-2 text-2xl font-black text-gray-800">{subscriptionStatus}</div>
          {currentPlan ? (
            <div class="mt-1 text-sm text-gray-600">
              Plan: <span class="font-semibold text-gray-800">{currentPlan.name}</span>
            </div>
          ) : (
            <div class="mt-1 text-sm text-gray-600">Plan: <span class="font-semibold text-gray-800">—</span></div>
          )}
        </div>

        <div class="rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-xs text-gray-600">
          Tenant #{String(auth.tenant?.id ?? "")}
        </div>
      </div>

      <div class="mt-4 space-y-2 text-sm text-gray-700">
        {subscriptionStatus === "trial" && trialEndsAt ? (
          <>
            <div class="flex items-center justify-between">
              <span>Trial finaliza</span>
              <span class="font-semibold">{new Date(trialEndsAt as any).toLocaleString("es-AR")}</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Días restantes</span>
              <span class="font-semibold">{trialDaysLeft ?? "—"}</span>
            </div>
          </>
        ) : null}

        {subscriptionStatus === "active" && currentPeriodEnd ? (
          <>
            <div class="flex items-center justify-between">
              <span>Próximo vencimiento</span>
              <span class="font-semibold">{new Date(currentPeriodEnd as any).toLocaleString("es-AR")}</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Días restantes</span>
              <span class="font-semibold">{currentPeriodDaysLeft ?? "—"}</span>
            </div>
          </>
        ) : null}

        {subscriptionStatus === "pending" ? (
          <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-amber-900">
            <div class="font-semibold">Pago en proceso</div>
            <div class="text-xs mt-1 text-amber-800">
              Estamos esperando confirmación de Mercado Pago. Si recién pagaste, puede tardar unos minutos.
            </div>
          </div>
        ) : null}

        {subscriptionStatus === "past_due" ? (
          <div class="mt-3 rounded-xl border border-red-200 bg-red-50 p-3 text-red-900">
            <div class="font-semibold">Pago vencido</div>
            <div class="text-xs mt-1 text-red-800">
              Hay un pago pendiente. Regularizalo para recuperar el acceso completo.
            </div>
          </div>
        ) : null}

        {subscriptionStatus === "canceled" ? (
          <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 p-3 text-gray-900">
            <div class="font-semibold">Suscripción cancelada</div>
            <div class="text-xs mt-1 text-gray-600">
              Podés volver a suscribirte cuando quieras.
            </div>
          </div>
        ) : null}
      </div>
    </div>

    <!-- Planes disponibles -->
    <div class="bg-white rounded-2xl shadow-lg p-5 lg:col-span-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm font-semibold text-gray-900">Planes</div>
          <div class="text-xs text-gray-600 mt-1">Elegí un plan para continuar usando Zuma+.</div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        {plans
          .filter((p: any) => p.is_active)
          .map((p: any) => (
            <SubscribeCard
              client:load
              planKey={String(p.key)}
              planName={String(p.name)}
              priceLabel={`${fmtMoney(p.price_amount, p.currency)} / mes`}
              isCurrent={Boolean(currentPlanId && p.plan_id === currentPlanId)}
              subscriptionStatus={subscriptionStatus}
              trialDaysLeft={trialDaysLeft}
            />
          ))}
      </div>

      <div class="mt-4 text-xs text-gray-500">
        * La activación puede demorar unos minutos en reflejarse (webhook).
      </div>
    </div>
  </div>
</LayoutDashboard>


<script is:inline src="https://sdk.mercadopago.com/js/v2"></script>
<script is:inline define:vars={{ MP_PUBLIC_KEY }}>
  window.__MP_PUBLIC_KEY__ = MP_PUBLIC_KEY;
</script>
