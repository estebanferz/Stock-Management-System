---
import Layout from "../../layouts/Layout.astro";
import {ActionPanel} from "@/components/ActionPanel";
import { SheetFormClient } from "@/components/SheetForms/SheetFormClient";
import { serverApp } from "@/lib/serverAPI";
import { clientColumns } from "@/config/ClientColumnConfig";
import { ClientsPageManager } from "@/components/PageManager/ClientPageManager";
import { requireAuth } from "@/lib/requireAuth";
import { User } from "lucide-react";
import { ClientMetricsOverview } from "@/components/ClientMetricsOverview";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");
const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };

const response = await serverApp.client.all.get({ query: { is_deleted: false } });
const data = Array.isArray(response.data)
    ? response.data
    : [];

---

<Layout title="Clientes" user={auth.user}>

  <h1 class="w-full text-3xl text-gray-700 font-bold mt-5">Clientes</h1>
  <p class="mb-5 text-sm text-gray-600 font-medium">Informaci√≥n relevante a los clientes de la empresa</p>

  <ClientMetricsOverview client:load/>
  
  <ClientsPageManager 
  client:load 
  initialData={data} 
  columns={clientColumns} 
  />
  
  <div class="justify-center mt-24 lg:mt-20 hidden md:block" slot="tercer-columna">
    <ActionPanel enabled={true} client:load />
  </div>

  
  <div
    class="group fixed right-10 bottom-10 z-30"
  >
    <span 
      class="absolute bottom-full right-0 mb-2 whitespace-nowrap rounded-md border bg-white px-4 py-2 
            text-sm font-medium text-black shadow-lg
            opacity-0 scale-95 transition-all duration-200 
            group-hover:opacity-100 group-hover:scale-100
            pointer-events-none"
    >
      Nuevo Cliente
    </span>

    <button
        id="btn-new-client"
        type="button"
        class="flex justify-center items-center h-16 w-16 rounded-full bg-white text-gray-500 hover:bg-mainColor hover:opacity-90 hover:text-white text-3xl shadow-lg"
    >
        <User />
    </button>

    <SheetFormClient zIndex={60} client:load/>
  </div>

</Layout>

<script is:inline>
document.getElementById("btn-new-client")?.addEventListener("click", () => {
    window.dispatchEvent(new CustomEvent("open-new-client"));
});
</script>