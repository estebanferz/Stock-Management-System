---
import LayoutDashboard from '../layouts/LayoutDashboard.astro';
import CustomCard from "@/components/CustomCard";
import { serverApp } from "@/lib/serverAPI";
import { SalesDataByMonth } from '@/utils/formatters';
import { PieChart } from '@/components/PieChart';
import { generalStringFormat } from "@/utils/formatters";
import { SalesAnnualSection } from "@/components/SalesAnnualSection";
import devicesIcon from '../assets/devices.svg';
import grossincome from "../assets/gross-income.svg";
import { requireAuth } from "@/lib/requireAuth";
import { NetIncomeCard } from '@/components/Dashboard/NetIncomeCard';
import { InvestmentCard } from "@/components/Dashboard/InvestmentCard";
import { DebtorsCard } from "@/components/Dashboard/DebtorsCard";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");
const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };

type Currency = "ARS" | "USD" | "EUR" | "BRL";

const initialYear = new Date().getFullYear();
const [
	currencyOverview,
	netIncomeBreakdown,
	stockInvestmentBreakdown,
	phoneSoldCount,
	saleDataByMonth,
	saleData,
] = await Promise.all([
	serverApp.currency.metrics["overview"].get(authed),

	serverApp.sale["net-income-breakdown"].get(authed),

	serverApp.phone["stock-investment-breakdown"].get(authed),

	serverApp.sale["products-sold-count"].get(authed),

	serverApp.sale["sales-by-month"].get({ ...authed, query: { year: String(initialYear) } }),

	serverApp.sale.all.get({ ...authed, query: { is_deleted: false } }),
]);

const displayCurrency: Currency =
  (currencyOverview.data?.displayCurrency as Currency) ?? "ARS";

const fmtMoney = (n: number) =>
  new Intl.NumberFormat("es-AR", {
    style: "currency",
    currency: displayCurrency,
    maximumFractionDigits: 2,
  }).format(Number.isFinite(n) ? n : 0);

// Gross income
const gross_income = Number(currencyOverview.data?.grossIncome ?? 0);

// Net Income
const net_income = Number(currencyOverview.data?.netIncome ?? 0);
const net_income_rows = Array.isArray(netIncomeBreakdown.data) ? netIncomeBreakdown.data : [];

// Investment in Stock
const stock_investment_total = Number(currencyOverview.data?.stockInvestment ?? 0);
const stock_rows = Array.isArray(stockInvestmentBreakdown.data) ? stockInvestmentBreakdown.data : [];

// Debtors
const debt_rows = Array.isArray(currencyOverview.data?.debtors) ? currencyOverview.data?.debtors : [];
const deudoresCountFormatted = debt_rows.length;
const totalDebtFormatted = currencyOverview.data?.total_debt ?? fmtMoney(0);

// Sales by month
const monthRows = Array.isArray(saleDataByMonth.data) ? saleDataByMonth.data : [];
const saleDataFormatted = SalesDataByMonth(monthRows);

// Units sold count
const units_sold_count = Array.isArray(saleData.data) ? saleData.data.length : 0;

// Expenses pie
const top_expense_rows = Array.isArray(currencyOverview.data?.top_expenses) ? currencyOverview.data?.top_expenses : [];
const expensePieData: (string | number)[][] = [
  ["Categoría", "Monto"],
  ...top_expense_rows.map((r: any) => [String(r.category ?? "Sin categoría"), Number(r.total ?? 0)]),
];

// Products sold pie
type ProductSoldCount = { name: string; sold_count: number };
const rows: ProductSoldCount[] = Array.isArray(phoneSoldCount.data) ? phoneSoldCount.data : [];
const formattedDataName = rows.map((item) => ({ ...item, name: generalStringFormat(item.name) }));
const pieChartData: (string | number)[][] = [
  ["Producto", "Unidades Vendidas"],
  ...formattedDataName.map((item) => [item.name, item.sold_count]),
];
const topExpenseTotal = top_expense_rows.reduce((acc: number, r: any) => acc + Number(r.total ?? 0), 0);
---

<LayoutDashboard title="StockManagement" user={auth.user}>
	<h1 class="px-3 w-full text-left text-4xl text-gray-700 font-bold mt-5 mb-2">Bienvenido{auth.userSettings ? `, ${auth.userSettings.display_name?.split(" ")[0]}` : ""}</h1>
	<p class="px-3 mb-8 text-sm text-gray-600 font-medium">Resumen completo de tu negocio con métricas clave</p>
	<div class="px-3 grid grid-cols-1 lg:grid-cols-3 gap-3 mb-4 items-start">
		<div class="lg:col-span-2 grid grid-rows-4 gap-1 p-4 bg-white rounded-2xl shadow-lg">
			<CustomCard title="Unidades Vendidas" description="Total de unidades vendidas" amount={String(units_sold_count)} icon={devicesIcon}/>
			<NetIncomeCard netIncome={fmtMoney(net_income)} rows={net_income_rows} client:load/>
			<InvestmentCard totalInvestment={fmtMoney(stock_investment_total)} rows={stock_rows} client:load />
			<CustomCard title="Ingresos Brutos" description="Ingresos brutos del negocio" amount={fmtMoney(gross_income)} icon={grossincome}/>
		</div>
		<div class="col-span-1 p-4 bg-white hover:bg-gray-50 rounded-2xl shadow-lg">
			<PieChart 
				data={expensePieData}
				title={`Gastos principales: ${fmtMoney(topExpenseTotal)}`}
				description="Top 5 categorías por monto acumulado"
				height="150px"
				client:load
			/>
		</div>
	</div>
	<div class="px-3">
		<SalesAnnualSection
			client:load
			initialYear={initialYear}
			initialData={saleDataFormatted}
		/>
	</div>
	</div>
	<div class="flex flex-col md:flex-row gap-3 mt-4 px-3 mb-10">
		<div class="flex justify-center md:w-1/2 p-4 bg-white hover:bg-gray-50 rounded-2xl shadow-lg">
			<PieChart 
				data={pieChartData}
				className="flex justify-center" 
				title="Productos más vendidos"
  				description="Top 5 productos más vendidos"
				client:load/>
		</div>
		<div class="w-full md:w-1/2">
			<DebtorsCard
				client:load
				count={deudoresCountFormatted}
				totalDebt={totalDebtFormatted}
				rows={debt_rows}
			/>
		</div>
	</div>

	</CenteredModal>
</Layout>