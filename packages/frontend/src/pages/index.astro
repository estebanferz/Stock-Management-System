---
import LayoutDashboard from '../layouts/LayoutDashboard.astro';
import CustomCard from "@/components/CustomCard";
import { serverApp } from "@/lib/serverAPI";
import { SalesDataByMonth } from '@/utils/formatters';
import { PieChart } from '@/components/PieChart';
import { generalStringFormat } from "@/utils/formatters";
import { SalesAnnualSection } from "@/components/SalesAnnualSection";
import moneyIcon from '../assets/money-income.svg';
import devicesIcon from '../assets/devices.svg';
import grossincome from "../assets/gross-income.svg"
import expenseIcon from '../assets/expense.svg';
import debtIcon from "../assets/debt.svg";
import { requireAuth } from "@/lib/requireAuth";
import { NetIncomeCard } from '@/components/Dashboard/NetincomeCard';
import { InvestmentCard } from "@/components/Dashboard/InvestmentCard";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");
const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };

const resultGross = await serverApp.sale['gross-income'].get(authed)
const gross_income = String(resultGross.data);
const saleData = await serverApp.sale.all.get({ ...authed, query: { is_deleted: false }});
const units_sold_count = Array.isArray(saleData.data)
? saleData.data.length
: 0;
const expenseData = await serverApp.expense['expenses'].get(authed)
console.log(expenseData)
const expensesFormatted = expenseData.data || []
const initialYear = new Date().getFullYear();
const saleDataByMonth = await serverApp.sale["sales-by-month"].get({
	...authed,
	query: { year: String(initialYear) },
});
const row = Array.isArray(saleDataByMonth.data) ? saleDataByMonth.data : []
const saleDataFormatted = SalesDataByMonth(row);
const deudoresCount = await serverApp.client['debts'].get(authed)
const deudoresCountFormatted = Array.isArray(deudoresCount.data)
? deudoresCount.data.length
: 0;
const totalDebt = await serverApp.client['total-debt'].get(authed)
const totalDebtFormatted = totalDebt.data || 0;

//net-income
const resultNet = await serverApp.sale['net-income'].get(authed)
const net_income = String(resultNet.data);
const netIncomeBreakdown = await serverApp.sale["net-income-breakdown"].get(authed);
const net_income_rows = Array.isArray(netIncomeBreakdown.data) ? netIncomeBreakdown.data : [];

//investment
const stockInvestment = await serverApp.phone["stock-investment"].get(authed);
const stock_investment_total = String(stockInvestment.data ?? 0);
const stockInvestmentBreakdown = await serverApp.phone["stock-investment-breakdown"].get(authed);
const stock_rows = Array.isArray(stockInvestmentBreakdown.data) ? stockInvestmentBreakdown.data : [];


type ProductSoldCount = { name: string; sold_count: number };
const phoneSoldCount = await serverApp.sale["products-sold-count"].get(authed);
const rows: ProductSoldCount[] = Array.isArray(phoneSoldCount.data)
  ? phoneSoldCount.data
  : [];
const formattedDataName = rows.map((item: ProductSoldCount) => ({
  ...item,
  name: generalStringFormat(item.name),
}));

const pieChartData: (string | number)[][] = [
  ["Producto", "Unidades Vendidas"],
  ...formattedDataName.map((item) => [item.name, item.sold_count]),
];

const secondaryData = `
    <div>
        <p>${deudoresCountFormatted}</p>
    </div>
`;
---

<LayoutDashboard title="StockManagement" user={auth.user}>
	<h1 class="px-3 w-full text-left text-4xl text-gray-700 font-bold mt-5 mb-2">Dashboard</h1>
	<p class="px-3 mb-8 text-sm text-gray-600 font-medium">Resumen completo de tu negocio con m√©tricas clave</p>
	<div class="px-3 grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
		<CustomCard title="Unidades Vendidas" amount={String(units_sold_count)} icon={devicesIcon}/>
		<NetIncomeCard netIncome={net_income} rows={net_income_rows} client:load/>
		<InvestmentCard totalInvestment={stock_investment_total} rows={stock_rows} client:load />
		<CustomCard title="Ingresos Brutos" amount={`$${gross_income}`} icon={grossincome}/>
		<CustomCard title="Gastos Totales" amount={`$${expensesFormatted}`} icon={expenseIcon}/>
	</div>
	<div class="px-3">
		<SalesAnnualSection
			client:load
			initialYear={initialYear}
			initialData={saleDataFormatted}
		/>
	</div>
	</div>
	<div class="flex flex-col md:flex-row gap-3 mt-4 px-3 mb-10">
		<div class="flex justify-center md:w-1/2 p-3 bg-white hover:bg-gray-50 rounded-2xl shadow-lg">
			<PieChart data={pieChartData} className="flex justify-center" client:load/>
		</div>
		<div class="w-1/2">
			<CustomCard title="Deudores" amount=`$${totalDebtFormatted}` secondaryData={secondaryData} icon={debtIcon}/>
		</div>
	</div>

	</CenteredModal>
</Layout>
