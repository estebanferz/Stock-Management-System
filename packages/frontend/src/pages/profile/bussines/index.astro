---
import "@/styles/tailwind.css";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import LayoutProfile from "@/layouts/LayoutProfile.astro";
import { requireAuth } from "@/lib/requireAuth";

import TenantSettingsForm from "@/components/TenantSettingsForm";

const auth = await requireAuth(Astro);
if (!auth) return Astro.redirect("/login");

const { tenant, roleInTenant, tenantSettings } = auth.auth;

const businessName =
  tenantSettings?.business_name?.trim() ||
  tenant?.name?.trim() ||
  "Empresa sin nombre";

const fmtDate = (d: any) => {
  try {
    if (!d) return "‚Äî";
    const dt = typeof d === "string" ? new Date(d) : d;
    if (Number.isNaN(dt?.getTime?.())) return "‚Äî";
    return dt.toLocaleString("es-AR", { dateStyle: "short", timeStyle: "short" });
  } catch {
    return "‚Äî";
  }
};

const boolLabel = (b: any) => (b === true ? "S√≠" : b === false ? "No" : "‚Äî");
---

<LayoutProfile>
  <Fragment slot="content">
    <div class="grid gap-6">
      <Card className="rounded-2xl shadow-sm">
        <CardHeader>
          <div class="flex items-start gap-4">
            <!-- Avatar circular (logo o fallback) -->
            <div class="h-14 w-14 shrink-0 overflow-hidden rounded-full border bg-slate-100">
              {
                tenantSettings?.logo_url ? (
                  <img
                    src={tenantSettings.logo_url}
                    alt={`Logo de ${businessName}`}
                    class="h-full w-full object-cover"
                    loading="lazy"
                    referrerpolicy="no-referrer"
                  />
                ) : (
                  <div class="flex h-full w-full items-center justify-center text-base font-semibold text-slate-700">
                    {businessName
                      .split(" ")
                      .filter(Boolean)
                      .slice(0, 2)
                      .map((w) => w[0]?.toUpperCase())
                      .join("") || "üè¢"}
                  </div>
                )
              }
            </div>

            <div class="min-w-0">
              <CardTitle className="truncate">{businessName}</CardTitle>
              <CardDescription>Datos del negocio y configuraci√≥n</CardDescription>

              <div class="pt-2 flex flex-wrap items-center gap-2">
                <Badge variant="outline" className="bg-slate-50">
                  Tenant ID: {tenant?.id ?? "‚Äî"}
                </Badge>
                <Badge variant="outline" className="bg-slate-50">
                  Rol: {roleInTenant ?? "staff"}
                </Badge>
              </div>
            </div>
          </div>
        </CardHeader>

        <CardContent className="grid gap-4 sm:grid-cols-2">
          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Tenant name (interno)</div>
            <div class="pt-1 text-base font-medium text-slate-900">{tenant?.name ?? "‚Äî"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Activo</div>
            <div class="pt-1 text-base font-medium text-slate-900">{boolLabel(tenant?.is_active)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Creado</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(tenant?.created_at)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Actualizado</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(tenant?.updated_at)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Moneda</div>
            <div class="pt-1 text-base font-medium text-slate-900">
              {tenantSettings?.display_currency ?? "ARS"}
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Timezone</div>
            <div class="pt-1 text-base font-medium text-slate-900">
              {tenantSettings?.timezone ?? "America/Argentina/Buenos_Aires"}
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Stock m√≠nimo</div>
            <div class="pt-1 text-base font-medium text-slate-900">
              {tenantSettings?.low_stock_threshold_default ?? 3}
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Actualizado (settings)</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(tenantSettings?.updated_at)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4 sm:col-span-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">CUIT</div>
            <div class="pt-1 text-sm text-slate-900">{tenantSettings?.cuit ?? "‚Äî"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4 sm:col-span-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">Direcci√≥n</div>
            <div class="pt-1 text-sm text-slate-900">{tenantSettings?.address ?? "‚Äî"}</div>
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl shadow-sm">
        <CardHeader>
          <CardTitle>Editar empresa</CardTitle>
        </CardHeader>

        <CardContent className="rounded-2xl border bg-white p-4">
          <TenantSettingsForm
            client:load
            tenant={tenant}
            roleInTenant={roleInTenant}
            tenantSettings={tenantSettings}
          />
        </CardContent>
      </Card>
    </div>
  </Fragment>
</LayoutProfile>
