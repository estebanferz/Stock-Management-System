---
import "@/styles/tailwind.css";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import LayoutProfile from "@/layouts/LayoutProfile.astro";
import { requireAuth } from "@/lib/requireAuth";

const auth = await requireAuth(Astro);
if (!auth) return Astro.redirect("/login");

const { user, tenant, roleInTenant, tenantSettings } = auth.auth;

const initials = (email: string) => {
  const name = email.split("@")[0] || "";
  const parts = name.replace(/[._-]+/g, " ").trim().split(" ").filter(Boolean);
  const a = (parts[0]?.[0] ?? email[0] ?? "?").toUpperCase();
  const b = (parts[1]?.[0] ?? parts[0]?.[1] ?? "").toUpperCase();
  return `${a}${b}`.trim();
};

const businessName =
  tenantSettings?.business_name?.trim() ||
  tenant?.name?.trim() ||
  "Empresa sin nombre";
---

<LayoutProfile>
  <Fragment slot="content">
    <!-- ‚Äúsub-layout‚Äù interno: nav Usuario/Empresa + cards -->
    <div class="grid gap-6">

        <Card id="empresa" className="rounded-2xl shadow-sm scroll-mt-24">
        <CardHeader>
            <div class="flex items-start gap-4">
            <!-- Avatar circular (logo o fallback) -->
            <div class="h-12 w-12 shrink-0 overflow-hidden rounded-full border bg-slate-100">
                {
                tenantSettings?.logo_url ? (
                    <img
                    src={tenantSettings.logo_url}
                    alt={`Logo de ${businessName}`}
                    class="h-full w-full object-cover"
                    loading="lazy"
                    referrerpolicy="no-referrer"
                    />
                ) : (
                    <div class="flex h-full w-full items-center justify-center text-sm font-semibold text-slate-700">
                    {businessName
                        .split(" ")
                        .filter(Boolean)
                        .slice(0, 2)
                        .map((w) => w[0]?.toUpperCase())
                        .join("") || "üè¢"}
                    </div>
                )
                }
            </div>

            <!-- T√≠tulo real + descripci√≥n -->
            <div class="min-w-0">
                <CardTitle className="truncate">{businessName}</CardTitle>
                <CardDescription>Datos del negocio y configuraci√≥n</CardDescription>

                <div class="pt-2">
                <Badge variant="outline" className="bg-slate-50">
                    Tenant ID: {tenant?.id}
                </Badge>
                </div>
            </div>
            </div>
        </CardHeader>

        <CardContent className="grid gap-4 sm:grid-cols-2">
            <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Moneda</div>
            <div class="pt-1 text-base font-medium text-slate-900">
                {tenantSettings?.default_currency ?? "ARS"}
            </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Timezone</div>
            <div class="pt-1 text-base font-medium text-slate-900">
                {tenantSettings?.timezone ?? "America/Argentina/Buenos_Aires"}
            </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Stock m√≠nimo</div>
            <div class="pt-1 text-base font-medium text-slate-900">
                {tenantSettings?.low_stock_threshold_default ?? 3}
            </div>
            </div>
        </CardContent>

        <CardFooter className="flex justify-end border-t px-6 py-4">
            <Button disabled>Guardar</Button>
        </CardFooter>
        </Card>

      </section>
    </div>
  </Fragment>
</LayoutProfile>
