---
import "@/styles/tailwind.css";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import LayoutProfile from "@/layouts/LayoutProfile.astro";
import { requireAuth } from "@/lib/requireAuth";
import CustomCard from "@/components/CustomCard";
import UserIcon from "../../assets/user.svg";
import RoleIcon from "../../assets/role.svg";
import BuildingIcon from "../../assets/building.svg";
import TimeIcon from "../../assets/clock.svg";

const auth = await requireAuth(Astro);
if (!auth) return Astro.redirect("/login");

const { user, tenant, roleInTenant, tenantSettings } = auth.auth;

const businessName =
  tenantSettings?.business_name?.trim() ||
  tenant?.name?.trim() ||
  "Empresa sin nombre";

const fmtDate = (d: any) => {
  try {
    if (!d) return "—";
    const dt = typeof d === "string" ? new Date(d) : d;
    if (Number.isNaN(dt?.getTime?.())) return "—";
    return dt.toLocaleString("es-AR", { dateStyle: "short", timeStyle: "short" });
  } catch {
    return "—";
  }
};

const boolLabel = (b: any) => (b === true ? "Sí" : b === false ? "No" : "—");

const stat = (title: string, value: any, icon: any) => ({ title, value, icon });

const stats = [
  stat("Usuario", user?.email ?? "—", UserIcon),
  stat("Rol empresa", roleInTenant ?? "staff", RoleIcon),
  stat("Empresa", businessName, BuildingIcon),
  stat(
    "Timezone",
    tenantSettings?.timezone ?? "America/Argentina/Buenos_Aires",
    TimeIcon
  ),
];
---

<LayoutProfile>
  <Fragment slot="content">
    <div class="grid gap-6">
    <Card className="rounded-2xl shadow-sm">
      <CardHeader className="pb-3">
        <CardTitle className="text-base">Resumen</CardTitle>
        <CardDescription className="text-sm">
          Datos rápidos de tu sesión actual
        </CardDescription>
      </CardHeader>

      <CardContent className="divide-y">
        {stats.map((s) => (
          <div class="flex items-center gap-3 py-3">
            <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-slate-100">
              <s.icon class="h-4 w-4 text-slate-600" />
            </div>

            <div class="flex min-w-0 flex-1 items-center justify-between gap-4">
              <div class="text-sm text-slate-600">{s.title}</div>

              <div class="min-w-0 text-right text-sm font-medium text-slate-900 truncate">
                {s.value}
              </div>
            </div>
          </div>
        ))}
      </CardContent>
    </Card>

      <!-- Detalle: Usuario -->
      <Card className="rounded-2xl shadow-sm">
        <CardHeader>
          <CardTitle>Cuenta</CardTitle>
          <CardDescription>Datos del usuario (tabla <code>users</code>)</CardDescription>
        </CardHeader>

        <CardContent className="grid gap-4 sm:grid-cols-2">
          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Email</div>
            <div class="pt-1 text-base font-medium text-slate-900">{user?.email ?? "—"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">User ID</div>
            <div class="pt-1 font-mono text-sm text-slate-900">{user?.id ?? "—"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Rol app</div>
            <div class="pt-2">
              <Badge variant="outline" className="bg-slate-50">{user?.role ?? "user"}</Badge>
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Activo</div>
            <div class="pt-1 text-base font-medium text-slate-900">{boolLabel(user?.is_active)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Creado</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(user?.created_at)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Último login</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(user?.last_login)}</div>
          </div>
        </CardContent>

        <div class="flex items-center justify-end border-t px-6 py-4">
          <a
            href="/profile/user"
            class="rounded-xl border bg-white px-4 py-2 text-sm font-medium text-slate-900 shadow-sm hover:bg-slate-50"
          >
            Editar perfil
          </a>
        </div>
      </Card>

      <!-- Detalle: Empresa + Settings -->
      <Card className="rounded-2xl shadow-sm">
        <CardHeader>
          <CardTitle>Empresa</CardTitle>
          <CardDescription>Tenant y configuración (tablas <code>tenants</code> y <code>tenant_settings</code>)</CardDescription>
        </CardHeader>

        <CardContent className="grid gap-4 sm:grid-cols-2">
          <div class="rounded-xl border bg-white p-4 sm:col-span-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">Nombre (resuelto)</div>
            <div class="pt-1 text-base font-semibold text-slate-900">{businessName}</div>
            <div class="pt-2">
              <Badge variant="outline" className="bg-slate-50">
                Tenant ID: {tenant?.id ?? "—"}
              </Badge>
              <span class="ml-2 text-xs text-slate-500">
                Rol: <span class="font-medium text-slate-700">{roleInTenant ?? "staff"}</span>
              </span>
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Tenant name (interno)</div>
            <div class="pt-1 text-base font-medium text-slate-900">{tenant?.name ?? "—"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Activo</div>
            <div class="pt-1 text-base font-medium text-slate-900">{boolLabel(tenant?.is_active)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Creado</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(tenant?.created_at)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Actualizado</div>
            <div class="pt-1 text-sm text-slate-900">{fmtDate(tenant?.updated_at)}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Moneda</div>
            <div class="pt-1 text-base font-medium text-slate-900">{tenantSettings?.default_currency ?? "ARS"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Timezone</div>
            <div class="pt-1 text-base font-medium text-slate-900">
              {tenantSettings?.timezone ?? "America/Argentina/Buenos_Aires"}
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Stock mínimo</div>
            <div class="pt-1 text-base font-medium text-slate-900">
              {tenantSettings?.low_stock_threshold_default ?? 3}
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4">
            <div class="text-xs uppercase tracking-wide text-slate-500">Logo URL</div>
            <div class="pt-1 break-all text-sm text-slate-900">
              {tenantSettings?.logo_url ?? "—"}
            </div>
          </div>

          <div class="rounded-xl border bg-white p-4 sm:col-span-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">CUIT</div>
            <div class="pt-1 text-sm text-slate-900">{tenantSettings?.cuit ?? "—"}</div>
          </div>

          <div class="rounded-xl border bg-white p-4 sm:col-span-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">Dirección</div>
            <div class="pt-1 text-sm text-slate-900">{tenantSettings?.address ?? "—"}</div>
          </div>
        </CardContent>

        <div class="flex items-center justify-end border-t px-6 py-4">
          <a
            href="/profile/bussines"
            class="rounded-xl border bg-white px-4 py-2 text-sm font-medium text-slate-900 shadow-sm hover:bg-slate-50"
          >
            Editar empresa
          </a>
        </div>
      </Card>
    </div>
  </Fragment>
</LayoutProfile>
