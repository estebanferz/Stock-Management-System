---
import "@/styles/tailwind.css";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import LayoutProfile from "@/layouts/LayoutProfile.astro";
import { requireAuth } from "@/lib/requireAuth";

const auth = await requireAuth(Astro);
if (!auth) return Astro.redirect("/login");

const { user, tenant, roleInTenant, tenantSettings } = auth.auth;

const initials = (email: string) => {
  const name = email.split("@")[0] || "";
  const parts = name.replace(/[._-]+/g, " ").trim().split(" ").filter(Boolean);
  const a = (parts[0]?.[0] ?? email[0] ?? "?").toUpperCase();
  const b = (parts[1]?.[0] ?? parts[0]?.[1] ?? "").toUpperCase();
  return `${a}${b}`.trim();
};

const prettyRole = (r?: string | null) => (r ? r : "user");
const prettyTenantRole = (r?: string | null) => (r ? r : "staff");

const businessName =
  tenantSettings?.business_name?.trim() ||
  tenant?.name?.trim() ||
  "Empresa sin nombre";

const timezone = tenantSettings?.timezone ?? "America/Argentina/Buenos_Aires";
const currency = tenantSettings?.default_currency ?? "ARS";
const lowStock = tenantSettings?.low_stock_threshold_default ?? 3;
---

<LayoutProfile>
  <Fragment slot="content">
    <div class="mx-auto w-full max-w-5xl space-y-6">
      <!-- Header -->
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-1">
          <h1 class="text-3xl font-semibold tracking-tight">Perfil</h1>
          <p class="text-sm text-slate-600">
            Información de tu cuenta y de tu empresa (tenant).
          </p>
        </div>

        <div class="flex items-center gap-3">
          <div class="relative flex h-14 w-14 items-center justify-center rounded-full bg-slate-200 text-xl font-semibold text-slate-900">
            <span>{initials(user.email)}</span>
          </div>

          <div class="min-w-[220px]">
            <div class="text-sm font-medium text-slate-900">{user.email}</div>
            <div class="flex flex-wrap gap-2 pt-1">
              <Badge variant="outline" className="bg-slate-50">
                App: {prettyRole(user.role)}
              </Badge>
              <Badge variant="outline" className="bg-slate-50">
                Tenant: {prettyTenantRole(roleInTenant)}
              </Badge>
            </div>
          </div>
        </div>
      </div>

      <!-- Grid -->
      <div class="grid gap-6 lg:grid-cols-2">
        <!-- Usuario -->
        <Card className="rounded-2xl shadow-sm">
          <CardHeader>
            <CardTitle>Usuario</CardTitle>
            <CardDescription>Datos de tu cuenta</CardDescription>
          </CardHeader>

          <CardContent className="space-y-4">
            <div class="rounded-xl border bg-white p-4">
              <div class="flex items-start justify-between gap-4">
                <div class="space-y-1">
                  <div class="text-xs uppercase tracking-wide text-slate-500">Email</div>
                  <div class="text-base font-medium text-slate-900">{user.email}</div>
                </div>
                <Button variant="outline" disabled>Editar</Button>
              </div>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <div class="rounded-xl border bg-white p-4">
                <div class="text-xs uppercase tracking-wide text-slate-500">Rol app</div>
                <div class="pt-1 text-base font-medium text-slate-900">
                  {prettyRole(user.role)}
                </div>
              </div>

              <div class="rounded-xl border bg-white p-4">
                <div class="text-xs uppercase tracking-wide text-slate-500">Rol en empresa</div>
                <div class="pt-1 text-base font-medium text-slate-900">
                  {prettyTenantRole(roleInTenant)}
                </div>
              </div>

              <div class="rounded-xl border bg-white p-4 sm:col-span-2">
                <div class="text-xs uppercase tracking-wide text-slate-500">User ID</div>
                <div class="pt-1 font-mono text-sm text-slate-900">{user.id}</div>
              </div>
            </div>
          </CardContent>

          <CardFooter className="flex items-center justify-between border-t px-6 py-4">
            <div class="text-xs text-slate-500">
              Próximo: nombre/apellido, avatar, preferencias personales.
            </div>
            <Button disabled>Guardar</Button>
          </CardFooter>
        </Card>

        <!-- Empresa / Tenant -->
        <Card className="rounded-2xl shadow-sm">
          <CardHeader>
            <CardTitle>Empresa</CardTitle>
            <CardDescription>Datos del tenant y configuración</CardDescription>
          </CardHeader>

          <CardContent className="space-y-4">
            <div class="rounded-xl border bg-white p-4">
              <div class="flex items-start justify-between gap-4">
                <div class="space-y-1">
                  <div class="text-xs uppercase tracking-wide text-slate-500">Nombre</div>
                  <div class="text-base font-medium text-slate-900">{businessName}</div>
                </div>
                <Button variant="outline" disabled>Editar</Button>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <Badge variant="outline" className="bg-slate-50">
                  Tenant ID: {tenant.id}
                </Badge>
                <Badge variant="outline" className="bg-slate-50">
                  Moneda: {currency}
                </Badge>
                <Badge variant="outline" className="bg-slate-50">
                  Zona horaria: {timezone}
                </Badge>
                <Badge variant="outline" className="bg-slate-50">
                  Stock mínimo: {lowStock}
                </Badge>
              </div>
            </div>

            <div class="grid gap-4 sm:grid-cols-2">
              <div class="rounded-xl border bg-white p-4">
                <div class="text-xs uppercase tracking-wide text-slate-500">Logo</div>
                <div class="pt-2">
                  {tenantSettings?.logo_url ? (
                    <div class="flex items-center gap-3">
                      <img
                        src={tenantSettings.logo_url}
                        alt="Logo de empresa"
                        class="h-12 w-12 rounded-xl border object-cover"
                      />
                      <div class="truncate text-sm text-slate-700">
                        {tenantSettings.logo_url}
                      </div>
                    </div>
                  ) : (
                    <div class="text-sm text-slate-500">Sin logo</div>
                  )}
                </div>
              </div>

              <div class="rounded-xl border bg-white p-4">
                <div class="text-xs uppercase tracking-wide text-slate-500">CUIT</div>
                <div class="pt-2 text-sm text-slate-700">
                  {tenantSettings?.cuit ? tenantSettings.cuit : "No configurado"}
                </div>
              </div>

              <div class="rounded-xl border bg-white p-4 sm:col-span-2">
                <div class="text-xs uppercase tracking-wide text-slate-500">Dirección</div>
                <div class="pt-2 text-sm text-slate-700">
                  {tenantSettings?.address ? tenantSettings.address : "No configurada"}
                </div>
              </div>
            </div>
          </CardContent>

          <CardFooter className="flex items-center justify-between border-t px-6 py-4">
            <div class="text-xs text-slate-500">
              Próximo: editar tenant settings y gestión de miembros.
            </div>
            <Button disabled>Guardar</Button>
          </CardFooter>
        </Card>
      </div>
    </div>
  </Fragment>
</LayoutProfile>
