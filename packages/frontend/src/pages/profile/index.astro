---
import "@/styles/tailwind.css";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import LayoutProfile from "@/layouts/LayoutProfile.astro";
import { requireAuth } from "@/lib/requireAuth";

const auth = await requireAuth(Astro);
if (!auth) return Astro.redirect("/login");

const { user, tenant, roleInTenant, tenantSettings } = auth.auth;

const initials = (email: string) => {
  const name = email.split("@")[0] || "";
  const parts = name.replace(/[._-]+/g, " ").trim().split(" ").filter(Boolean);
  const a = (parts[0]?.[0] ?? email[0] ?? "?").toUpperCase();
  const b = (parts[1]?.[0] ?? parts[0]?.[1] ?? "").toUpperCase();
  return `${a}${b}`.trim();
};

const businessName =
  tenantSettings?.business_name?.trim() ||
  tenant?.name?.trim() ||
  "Empresa sin nombre";
---

<LayoutProfile>
  <Fragment slot="content">
    <!-- “sub-layout” interno: nav Usuario/Empresa + cards -->
    <div class="grid gap-6 lg:grid-cols-[220px_1fr]">
      <!-- Nav interno -->
      <aside class="h-fit rounded-2xl border bg-white p-4 shadow-sm">
        <div class="flex items-center gap-3 pb-4">
          <div class="flex h-11 w-11 items-center justify-center rounded-full bg-slate-200 text-base font-semibold text-slate-900">
            {initials(user.email)}
          </div>
          <div class="min-w-0">
            <div class="truncate text-sm font-medium text-slate-900">{user.email}</div>
            <div class="pt-1 text-xs text-slate-500">Tenant: {tenant?.name}</div>
          </div>
        </div>

        <nav class="grid gap-1 text-sm">
          <a href="#usuario" class="rounded-xl px-3 py-2 font-medium text-slate-900 hover:bg-slate-50">
            Usuario
          </a>
          <a href="#empresa" class="rounded-xl px-3 py-2 font-medium text-slate-900 hover:bg-slate-50">
            Empresa
          </a>
        </nav>
      </aside>

      <!-- Cards -->
      <section class="space-y-6">
        <Card id="usuario" className="rounded-2xl shadow-sm scroll-mt-24">
          <CardHeader>
            <CardTitle>Usuario</CardTitle>
            <CardDescription>Información de tu cuenta</CardDescription>
          </CardHeader>

          <CardContent className="grid gap-4 sm:grid-cols-2">
            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Email</div>
              <div class="pt-1 text-base font-medium text-slate-900">{user.email}</div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">User ID</div>
              <div class="pt-1 font-mono text-sm text-slate-900">{user.id}</div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Rol app</div>
              <div class="pt-2">
                <Badge variant="outline" className="bg-slate-50">{user.role ?? "user"}</Badge>
              </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Rol empresa</div>
              <div class="pt-2">
                <Badge variant="outline" className="bg-slate-50">{roleInTenant ?? "staff"}</Badge>
              </div>
            </div>
          </CardContent>

          <CardFooter className="flex justify-end border-t px-6 py-4">
            <Button variant="outline" disabled>Editar</Button>
          </CardFooter>
        </Card>

        <Card id="empresa" className="rounded-2xl shadow-sm scroll-mt-24">
          <CardHeader>
            <CardTitle>Empresa</CardTitle>
            <CardDescription>Datos del negocio y configuración</CardDescription>
          </CardHeader>

          <CardContent className="grid gap-4 sm:grid-cols-2">
            <div class="rounded-xl border bg-white p-4 sm:col-span-2">
              <div class="text-xs uppercase tracking-wide text-slate-500">Nombre</div>
              <div class="pt-1 text-base font-medium text-slate-900">{businessName}</div>
              <div class="pt-2">
                <Badge variant="outline" className="bg-slate-50">
                  Tenant ID: {tenant?.id}
                </Badge>
              </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Moneda</div>
              <div class="pt-1 text-base font-medium text-slate-900">
                {tenantSettings?.default_currency ?? "ARS"}
              </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Timezone</div>
              <div class="pt-1 text-base font-medium text-slate-900">
                {tenantSettings?.timezone ?? "America/Argentina/Buenos_Aires"}
              </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Stock mínimo</div>
              <div class="pt-1 text-base font-medium text-slate-900">
                {tenantSettings?.low_stock_threshold_default ?? 3}
              </div>
            </div>

            <div class="rounded-xl border bg-white p-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">Logo</div>
              <div class="pt-2 text-sm text-slate-600">
                {tenantSettings?.logo_url ? tenantSettings.logo_url : "Sin logo"}
              </div>
            </div>
          </CardContent>

          <CardFooter className="flex justify-end border-t px-6 py-4">
            <Button disabled>Guardar</Button>
          </CardFooter>
        </Card>
      </section>
    </div>
  </Fragment>
</LayoutProfile>
