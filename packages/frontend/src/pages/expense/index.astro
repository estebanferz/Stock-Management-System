---

import Layout from "../../layouts/Layout.astro";
import { SheetFormExpense } from "@/components/SheetForms/SheetFormExpense";
import { serverApp } from "@/lib/serverAPI";
import { expenseColumns } from "@/config/ExpenseColumnConfig";
import ActionPanel from "@/components/ActionPanel";
import { ExpensesPageManager } from "@/components/PageManager/ExpensePageManager";
import { requireAuth } from "@/lib/requireAuth";
import { Receipt } from "lucide-react";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");
const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };
    
const [expensesRes, providersRes] = await Promise.all([
    serverApp.expense.all.get({ ...authed, query : { is_deleted: false }}),
    serverApp.provider.all.get(authed),
]);

const expenses = Array.isArray(expensesRes.data)
    ? expensesRes.data
    : [];
const providers = Array.isArray(providersRes.data)
    ? providersRes.data
    : [];

const providerNameById = new Map<number, string>(
    providers.map((c: any) => [c.provider_id, c.name ?? "—"])
);

const data = expenses.map((expense: any) => ({
  ...expense,
  provider_name: providerNameById.get(expense.provider_id) ?? "—",
}));
---

<Layout title="Gastos" user={auth.user}>
    <h1 class="w-full text-3xl text-gray-700 font-bold mt-5">Gastos</h1>
    <p class="mb-5 text-sm text-gray-600 font-medium">Comisiones, publicidad y demás gastos de la empresa</p>
    
    <ExpensesPageManager
    client:load
    initialExpenses={expenses}
    providers={providers}
    columns={expenseColumns}
    />

    <div class="justify-center mt-24 lg:mt-20 hidden md:block" slot="tercer-columna">
        <ActionPanel client:load />
    </div>

    <div
        class="group fixed right-10 bottom-10 z-30"
    >
        <span 
        class="absolute bottom-full right-0 mb-2 whitespace-nowrap rounded-md border bg-white px-4 py-2 
                text-sm font-medium text-black shadow-lg
                opacity-0 scale-95 transition-all duration-200 
                group-hover:opacity-100 group-hover:scale-100
                pointer-events-none"
        >
        Nuevo Gasto
        </span>

        <button
            id="btn-new-expense"
            type="button"
            class="flex justify-center items-center h-16 w-16 rounded-full bg-white text-gray-500 hover:bg-secondColor hover:opacity-90 hover:text-white text-3xl shadow-lg"
        >
            <Receipt />
        </button>

        <SheetFormExpense zIndex={60} client:load/>
    </div>
</Layout>

<script is:inline>
document.getElementById("btn-new-expense")?.addEventListener("click", () => {
    window.dispatchEvent(new CustomEvent("open-new-expense"));
});
</script>