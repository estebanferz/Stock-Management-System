---

import Layout from "../../layouts/Layout.astro";
import { SheetFormExpense } from "@/components/SheetForms/SheetFormExpense";
import { serverApp } from "@/lib/serverAPI";
import { expenseColumns } from "@/config/ExpenseColumnConfig";
import ActionPanel from "@/components/ActionPanel";
import { ExpensesPageManager } from "@/components/PageManager/ExpensePageManager";
import { requireAuth } from "@/lib/requireAuth";

const user = await requireAuth(Astro);
if (!user) return Astro.redirect("/login");
    
const [expensesRes, providersRes] = await Promise.all([
    serverApp.expense.all.get({ query : { is_deleted: false }}),
    serverApp.provider.all.get(),
]);

const expenses = Array.isArray(expensesRes.data)
    ? expensesRes.data
    : [];
const providers = Array.isArray(providersRes.data)
    ? providersRes.data
    : [];

const providerNameById = new Map<number, string>(
    providers.map((c: any) => [c.provider_id, c.name ?? "—"])
);

const data = expenses.map((expense: any) => ({
  ...expense,
  provider_name: providerNameById.get(expense.provider_id) ?? "—",
}));
---

<Layout title="Gastos" user={user}>
    <h1 class="w-full text-center text-4xl text-gray-700 font-bold my-5">Gastos</h1>
    
    <ExpensesPageManager
    client:load
    initialExpenses={expenses}
    providers={providers}
    columns={expenseColumns}
    />

    <div class="m-4 mt-20" slot="tercer-columna">
        <ActionPanel client:load />
    </div>

    <div slot="tercer-columna" class="group absolute bottom-10 right-10 hidden md:block lg:hidden">
        <span 
        class="absolute bottom-full right-0 mb-2 whitespace-nowrap rounded-md border bg-white px-4 py-2 
           text-sm font-medium text-black shadow-lg
           opacity-0 scale-95 transition-all duration-200 
           group-hover:opacity-100 group-hover:scale-100
           pointer-events-none"
        >
        Nuevo Gasto
        </span>
        <SheetFormExpense zIndex={60} client:load/>
    </div>

    <div class="group absolute bottom-10 right-10 hidden lg:block">
        <span 
        class="absolute bottom-full right-0 mb-2 whitespace-nowrap rounded-md border bg-white px-4 py-2 
           text-sm font-medium text-black shadow-lg
           opacity-0 scale-95 transition-all duration-200 
           group-hover:opacity-100 group-hover:scale-100
           pointer-events-none"
           >
           Nuevo gasto
        </span>
        <SheetFormExpense zIndex={60} client:load/>
    </div>
</Layout>