---

import Layout from "../../layouts/Layout.astro";
import { SheetFormRepair } from "@/components/SheetForms/SheetFormRepair";
import { serverApp } from "@/lib/serverAPI";
import { repairColumns } from "@/config/RepairColumnConfig";
import ActionPanel from "@/components/ActionPanel";
import { RepairPageManager } from "@/components/PageManager/RepairPageManager";
import { requireAuth } from "@/lib/requireAuth";
import { Hammer } from "lucide-react";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");
const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };

const [repairsRes, clientsRes, techniciansRes, phonesRes] = await Promise.all([
  serverApp.repair.all.get({ ...authed, query: { is_deleted: false }}),
  serverApp.client.all.get(authed),
  serverApp.technician.all.get(authed),
  serverApp.phone.all.get(authed),
]);
const repairs = Array.isArray(repairsRes.data)
    ? repairsRes.data
    : [];
const clients = Array.isArray(clientsRes.data)
    ? clientsRes.data
    : [];
const technicians = Array.isArray(techniciansRes.data)
    ? techniciansRes.data
    : [];
const phones = Array.isArray(phonesRes.data)
    ? phonesRes.data
    : [];

const clientNameById = new Map<number, string>(
  clients.map((c: any) => [c.client_id, c.name ?? "—"])
);

const technicianNameById = new Map<number, string>(
  technicians.map((t: any) => [t.technician_id, t.name ?? "—"])
);

const phoneLabelById = new Map<number, string>(
  phones.map((p: any) => [
    p.device_id,
    p.name ?? "-",
  ])
);

const data = repairs.map((repair: any) => ({
  ...repair,
  client_name: clientNameById.get(repair.client_id) ?? "—",
  technician_name: technicianNameById.get(repair.technician_id) ?? "—",
  device_name: phoneLabelById.get(repair.device_id) ?? "—",
}));

---

<Layout title="Reparaciones" user={auth.user}>

    <h1 class="w-full text-3xl text-gray-700 font-bold mt-5">Reparaciones</h1>
    <p class="mb-5 text-sm text-gray-600 font-medium">Centro de reparación de dispositivos</p>    

    <RepairPageManager
      client:load
      initialRepairs={repairs}
      clients={clients}
      technicians={technicians}
      phones={phones}
      columns={repairColumns}
    />

    <div class="justify-center mt-24 lg:mt-20 hidden md:block" slot="tercer-columna">
      <ActionPanel client:load />
    </div>

    <div
      class="group fixed right-10 bottom-10 z-30"
    >
      <span 
        class="absolute bottom-full right-0 mb-2 whitespace-nowrap rounded-md border bg-white px-4 py-2 
              text-sm font-medium text-black shadow-lg
              opacity-0 scale-95 transition-all duration-200 
              group-hover:opacity-100 group-hover:scale-100
              pointer-events-none"
      >
        Nueva Reparación
      </span>

      <button
        id="btn-new-repair"
        type="button"
        class="flex justify-center items-center h-16 w-16 rounded-full bg-white text-gray-500 hover:bg-secondColor hover:opacity-90 hover:text-white text-3xl shadow-lg"
      >
        <Hammer />
      </button>

      <SheetFormRepair client:load/>
    </div>
</Layout>

<script is:inline>
document.getElementById("btn-new-repair")?.addEventListener("click", () => {
    window.dispatchEvent(new CustomEvent("open-new-repair"));
});
</script>