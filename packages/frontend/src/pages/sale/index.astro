---

import Layout from "../../layouts/Layout.astro";
import { SheetFormSale } from "@/components/SheetForms/SheetFormSale";
import { serverApp } from "@/lib/serverAPI";
import { saleColumns } from "@/config/SaleColumnConfig.client";
import ActionPanel from "@/components/ActionPanel";
import { SalesPageManager } from "@/components/PageManager/SalePageManager";
import { requireAuth } from "@/lib/requireAuth";
import { Store } from "lucide-react";

const session = await requireAuth(Astro);
if (!session) return Astro.redirect("/login");
const { auth, cookieHeader } = session;
const authed = { headers: { cookie: cookieHeader } };

// 1) Traer todo en paralelo
const [salesRes, clientsRes, sellersRes, phonesRes] = await Promise.all([
  serverApp.sale.all.get({...authed, query : { is_deleted: false }}),
  serverApp.client.all.get(authed),
  serverApp.seller.all.get(authed),
  serverApp.phone.all.get(authed),
]);

const sales = Array.isArray(salesRes.data)
    ? salesRes.data
    : [];
const clients = Array.isArray(clientsRes.data)
    ? clientsRes.data
    : [];
const sellers = Array.isArray(sellersRes.data)
    ? sellersRes.data
    : [];
const phones = Array.isArray(phonesRes.data)
    ? phonesRes.data
    : [];

// 2) Mapas id -> nombre/label
const clientNameById = new Map<number, string>(
  clients.map((c: any) => [c.client_id, c.name ?? "—"])
);

const sellerNameById = new Map<number, string>(
  sellers.map((s: any) => [s.seller_id, s.name ?? "—"])
);

// Ajustá esto al “nombre” que quieras mostrar del dispositivo
const phoneLabelById = new Map<number, string>(
  phones.map((p: any) => [
    p.device_id,
    p.name ?? "-",
  ])
);

// 3) Enriquecer ventas con nombres
const data = sales.map((sale: any) => ({
  ...sale,
  client_name: clientNameById.get(sale.client_id) ?? "—",
  seller_name: sellerNameById.get(sale.seller_id) ?? "—",
  device_name: phoneLabelById.get(sale.device_id) ?? "—",
}));

console.log("Ventas:", data);

---

<Layout title="Ventas" user={auth.user}>
    <h1 class="w-full text-center text-4xl text-gray-700 font-bold my-5">Ventas</h1>
    
    <SalesPageManager
        client:load
        initialSales={sales}
        clients={clients}
        sellers={sellers}
        phones={phones}
        columns={saleColumns}
      />

    <div class="justify-center mt-24 lg:mt-20 hidden md:block" slot="tercer-columna">
      <ActionPanel client:load />
    </div>

    <div
      class="group fixed right-10 bottom-10 z-30"
    >
      <span 
        class="absolute bottom-full right-0 mb-2 whitespace-nowrap rounded-md border bg-white px-4 py-2 
              text-sm font-medium text-black shadow-lg
              opacity-0 scale-95 transition-all duration-200 
              group-hover:opacity-100 group-hover:scale-100
              pointer-events-none"
      >
        Nueva Venta
      </span>

      <button
          id="btn-new-sale"
          type="button"
          class="flex justify-center items-center h-16 w-16 rounded-full bg-white text-gray-500 hover:bg-mainColor hover:opacity-90 hover:text-white text-3xl shadow-lg"
      >
          <Store />
      </button>

      <SheetFormSale zIndex={60} client:load/>
    </div>
</Layout>

<script is:inline>
document.getElementById("btn-new-sale")?.addEventListener("click", () => {
    window.dispatchEvent(new CustomEvent("open-new-sale"));
});
</script>