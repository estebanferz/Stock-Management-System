import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{C as H,L as l,I as b}from"./input.MG_-FBsV.js";import{B as g}from"./button.Dcm3U4MY.js";import{r as d}from"./index.DAubIFHI.js";import{S as w,D as J,a as K,C as Q,b as W,c as X}from"./dropdown-menu.BysoY2q6.js";import{p as Y}from"./paymentMethods.QdXxarE_.js";import{C as ee}from"./checkbox.Cg_f7469.js";import{c}from"./clientAPI.Cs9ptr1e.js";import{SheetFormClient as te}from"./SheetFormClient.BJbrnch6.js";import{SheetFormPhone as ne}from"./SheetFormPhone.CI-5qlJQ.js";import"./x.BNoxzAwW.js";import"./index.C7LY66bV.js";import"./index.64NwWGNV.js";import"./utils.CDN07tui.js";import"./index.Dym27YVG.js";import"./parsePhoneNumber.CAsXhxWl.js";import"./SheetFormExpense.DjwUHo5V.js";import"./phoneCategories.BdKgBTqW.js";const re=()=>{const _=new Date;return new Date(_.getTime()-_.getTimezoneOffset()*6e4)};function Ce({zIndex:_}){const y=re(),[N,D]=d.useState(y.toISOString().split("T")[0]),[E,I]=d.useState(y.toISOString().slice(11,16)),[L,F]=d.useState(!1),[O,P]=d.useState(!1),[z,j]=d.useState(!1),[T,V]=d.useState(null),[n,i]=d.useState({datetime:"",total_amount:"",payment_method:"Pago",debt:!1,debt_amount:"",client_id:"",seller_id:"",device_id:"",trade_in_device:""});d.useEffect(()=>{const t=m=>{const r=m.detail;V(r);const o=r.datetime instanceof Date?r.datetime.toISOString():String(r.datetime),[a,u]=o.split("T");D(a),I(u.slice(0,5)),i({datetime:r.datetime?String(r.datetime):"",total_amount:r.total_amount?String(r.total_amount):"",payment_method:r.payment_method??"",debt:r.debt??!1,debt_amount:r.debt_amount?String(r.debt_amount):"",client_id:r.client_id?String(r.client_id):"",seller_id:r.seller_id?String(r.seller_id):"",device_id:r.device_id?String(r.device_id):"",trade_in_device:r.trade_in_device?String(r.trade_in_device):""}),j(!0)};return window.addEventListener("open-edit-sale",t),()=>window.removeEventListener("open-edit-sale",t)},[]);const $=(t,m)=>{i({...n,device_id:t}),m&&i(r=>({...r,total_amount:m}))},q=()=>{P(!0)},B=t=>{P(!1),t&&i({...n,trade_in_device:t})},R=async t=>{t.preventDefault(),t.stopPropagation();const m=a=>{const u=Number(a);return Number.isFinite(u)?Math.round(u):0},r=`${N}T${E}:00Z`;if(alert("Submitting sale with datetime:"+r),!n.client_id||!n.seller_id||!n.device_id){alert("Por favor, selecciona Cliente, Vendedor y Dispositivo.");return}const o={...n,datetime:r,debt_amount:n.debt?n.debt_amount:null,client_id:Number(n.client_id),payment_method:n.payment_method,device_id:Number(n.device_id),total_amount:n.total_amount,seller_id:Number(n.seller_id),trade_in_device:n.trade_in_device?Number(n.trade_in_device):null};try{let a;const u=!!T;if(u)a=await c.sale({id:T.sale_id}).put(o);else{if(a=await c.sale.post(o),o.debt&&o.debt_amount){const s=Number(o.client_id),h=m(o.debt_amount),{data:f,error:A}=await c.client({id:s}).get();if(A||!f)console.error("Error fetching client:",A);else{const Z=m(f.debt)+h,M={...f,debt:Z,id_number:String(f.id_number)};delete M.datetime;const{error:C}=await c.client({id:s}).put(M);C&&console.error("Failed to update client debt:",C.value??C)}}const v=o.seller_id,{data:p,error:x}=await c.seller({id:v}).get();if(x||!p)throw console.error("Error fetching seller data:",x),new Error("Failed to fetch seller data");const S=parseFloat(p.commission);try{const s={datetime:r,category:"Comisión",description:`Comisión por venta (${p.name})`,amount:String(Number(S)/100*Number(o.total_amount)),payment_method:o.payment_method??"Unknown",receipt_number:null,provider_id:null},{error:h}=await c.expense.post(s);h?console.error("Failed to create commission expense:",h.value??h):console.log("Commission expense created.")}catch(s){console.error("Error creating commission expense:",s)}}const{error:k}=a;if(k)throw k.value;if(!u){const v=Number(n.device_id),{data:p,error:x}=await c.phone({id:v}).get();if(x||!p){window.location.reload();return}const S={...p,sold:!0},{error:s}=await c.phone({id:v}).put(S);s?console.error("Falló la actualización final del dispositivo:",s.value):console.log("Device marked as sold.")}window.location.reload()}catch(a){console.error("Error al cargar venta:",a),alert("Error al cargar venta")}},U=()=>{F(!0)},G=t=>{F(!1),t&&i({...n,client_id:t})};return e.jsx("form",{id:"form-sale",onSubmit:R,children:e.jsxs(H,{className:"w-[400px] duration-300 flex flex-col",title:"Agregar Venta",zIndex:_,isOpen:z,onOpenChange:j,description:"Agregar venta de dispositivo al sistema",isModal:!0,footer:e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"submit",form:"form-sale",children:"Agregar"}),e.jsx(g,{variant:"outline",onClick:()=>j(!1),children:"Cancelar"})]}),children:[e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Fecha y hora"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(b,{type:"date",value:N,onChange:t=>D(t.target.value)}),e.jsx(b,{type:"time",value:E,onChange:t=>I(t.target.value)})]})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Vendedor"}),e.jsx(w,{type:"seller",currentId:n.seller_id,onSelect:t=>i({...n,seller_id:t})})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Cliente"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx("div",{className:"col-span-2",children:e.jsx(w,{type:"client",currentId:n.client_id,onSelect:t=>i({...n,client_id:t})})}),e.jsx(g,{className:"col-span-1",type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),U()},children:"Agregar"})]})]}),e.jsx(te,{isOpen:L,onClose:G,zIndex:60}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Dispositivo"}),e.jsx(w,{type:"device",currentId:n.device_id,onSelect:$})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Valor"}),e.jsx(b,{value:n.total_amount,onChange:t=>i({...n,total_amount:t.target.value}),type:"number",placeholder:"0.00",step:"0.01",required:!0})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Trade-In"}),e.jsx(g,{type:"button",onClick:q,children:"Agregar Trade-In"})]}),O&&e.jsx(ne,{isOpen:O,onClose:B,zIndex:60,depth:1}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Método de pago"}),e.jsxs(J,{children:[e.jsx(K,{asChild:!0,children:e.jsxs(g,{variant:"outline",className:"ml-auto w-full justify-between font-normal",children:[n.payment_method," ",e.jsx(Q,{})]})}),e.jsx(W,{align:"end",children:Y.map(t=>e.jsx(X,{onClick:()=>i({...n,payment_method:t.value}),children:t.label},t.value))})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx(l,{children:"Debe"}),e.jsx(ee,{checked:n.debt,onCheckedChange:t=>i({...n,debt:!!t})})]}),n.debt&&e.jsxs("div",{className:"grid gap-3",children:[e.jsx(l,{children:"Cuánto debe"}),e.jsx(b,{type:"number",value:n.debt_amount,onChange:t=>i({...n,debt_amount:t.target.value}),placeholder:"0.00",required:n.debt})]})]})})}export{Ce as SheetFormSale};
